<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³„ì•½ì „ë ¥ ì§„ë‹¨ ë° ì‹œë®¬ë ˆì´ì…˜</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 600px;
        }
        .hidden {
            display: none;
        }
        .warning {
            color: #ef4444; /* Tailwind red-500 */
            font-weight: bold;
        }
        .hint {
            background-color: #fef3c7; /* Tailwind yellow-100 */
            border-left: 4px solid #f59e0b; /* Tailwind yellow-500 */
            padding: 0.75rem;
            margin-top: 1rem;
            color: #92400e; /* Tailwind yellow-800 */
            font-size: 0.875rem;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="p-4">
    <div class="container mx-auto bg-white p-6 rounded-lg shadow-md mt-10">
        <h1 class="text-2xl font-bold text-center mb-6">ìš°ë¦¬ ê°€ê²Œ ê³„ì•½ì „ë ¥ ì§„ë‹¨</h1>

        <div class="mb-4">
            <label for="category" class="block text-gray-700 text-sm font-bold mb-2">ì—…ì¢… ëŒ€ë¶„ë¥˜</label>
            <select id="category" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ìŒì‹">ìŒì‹ì </option>
                <option value="ì†Œë§¤">ì†Œë§¤</option>
                <option value="êµìœ¡">êµìœ¡ ì„œë¹„ìŠ¤</option>
                <option value="ìˆ™ë°•">ìˆ™ë°•</option>
                <option value="ë³‘ì˜ì›">ë³‘ì˜ì›/ì•½êµ­</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€ ì„œë¹„ìŠ¤</option>
            </select>
            <p id="categoryError" class="text-red-500 text-xs italic hidden">ì—…ì¢… ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>

        <div id="subcategoryDiv" class="mb-4 hidden">
            <label for="subcategory" class="block text-gray-700 text-sm font-bold mb-2">ì—…ì¢… ì„¸ë¶„ë¥˜ (ì˜ˆ: ì¹˜í‚¨, í¸ì˜ì , í•™ì›)</label>
            <input type="text" id="subcategory" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="êµ¬ì²´ì ì¸ ì—…ì¢…ì„ ì…ë ¥í•˜ì„¸ìš”.">
            <p id="subcategoryError" class="text-red-500 text-xs italic hidden">ì—…ì¢… ì„¸ë¶„ë¥˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>

        <div class="mb-4">
            <label for="area" class="block text-gray-700 text-sm font-bold mb-2">ì‚¬ì—…ì¥ ë©´ì  (í‰)</label>
            <input type="number" id="area" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="ìˆ«ìë§Œ ì…ë ¥ (10, 20 ë“±)">
            <p id="areaError" class="text-red-500 text-xs italic hidden">ì‚¬ì—…ì¥ ë©´ì ì„ 1í‰ ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>

        <div class="mb-4">
            <label for="contractPower" class="block text-gray-700 text-sm font-bold mb-2">í˜„ì¬ ê³„ì•½ì „ë ¥ (kW)</label>
            <input type="number" id="contractPower" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="ìˆ«ìë§Œ ì…ë ¥ (5, 10 ë“±)">
            <p id="contractPowerError" class="text-red-500 text-xs italic hidden">í˜„ì¬ ê³„ì•½ì „ë ¥ì„ 1kW ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>

        <div class="mb-4">
            <label for="maxUsage" class="block text-gray-700 text-sm font-bold mb-2">ìµœëŒ€ ì›” ì‚¬ìš©ëŸ‰ (kWh)</label>
            <input type="number" id="maxUsage" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="ìˆ«ìë§Œ ì…ë ¥ (1000, 2500 ë“±)">
            <p id="maxUsageError" class="text-red-500 text-xs italic hidden">ìµœëŒ€ ì›” ì‚¬ìš©ëŸ‰ì„ 1kWh ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>

        <div class="mb-6 flex items-center">
            <input type="checkbox" id="is24h" class="mr-2 leading-tight">
            <label for="is24h" class="text-sm text-gray-700">24ì‹œê°„ ì˜ì—…í•˜ì‹œë‚˜ìš”?</label>
        </div>

        <div class="mb-6">
            <label class="flex items-center">
                <input type="checkbox" id="privacyConsent" class="mr-2 leading-tight">
                <span class="text-sm text-gray-700">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜ (ì§„ë‹¨ ê¸°ë¡ì„ ìœ„í•´ í•„ìš”)</span>
            </label>
        </div>

        <div class="flex items-center justify-between mb-6">
            <button id="diagnoseBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" disabled>
                ì§„ë‹¨í•˜ê¸°
            </button>
            <button id="simulateBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full hidden" disabled>
                ì¬ì‹œë®¬ë ˆì´ì…˜í•˜ê¸°
            </button>
        </div>

        <div id="result" class="bg-gray-100 p-4 rounded-lg mt-6 hidden">
            </div>

        <button id="detailBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full mt-4 hidden">
            ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°
        </button>

        <div id="details" class="bg-blue-50 p-4 rounded-lg mt-4 hidden text-sm leading-relaxed">
            </div>
    </div>

    <script>
        const category = document.getElementById('category');
        const subDiv = document.getElementById('subcategoryDiv');
        const subInput = document.getElementById('subcategory');
        const diagnoseBtn = document.getElementById('diagnoseBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const privacyConsent = document.getElementById('privacyConsent');
        const detailBtn = document.getElementById('detailBtn');
        const resultDiv = document.getElementById('result'); // ê²°ê³¼ div ìš”ì†Œ

        const inputStartTime = Date.now();

        function getSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = Math.random().toString(36).substring(2) + Date.now().toString(36);
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }
        const currentSessionId = getSessionId();

        const errors = {
            categoryError: document.getElementById('categoryError'),
            subcategoryError: document.getElementById('subcategoryError'),
            areaError: document.getElementById('areaError'),
            contractPowerError: document.getElementById('contractPowerError'),
            maxUsageError: document.getElementById('maxUsageError')
        };

        const fieldsToValidate = [
            { element: category, errorElement: errors.categoryError, validate: (val) => val.trim() !== '' },
            { element: subInput, errorElement: errors.subcategoryError, validate: (val) => !subDiv.classList.contains('hidden') ? val.trim() !== '' : true },
            { element: document.getElementById('area'), errorElement: errors.areaError, validate: (val) => parseInt(val) >= 1 },
            { element: document.getElementById('contractPower'), errorElement: errors.contractPowerError, validate: (val) => parseInt(val) >= 1 },
            { element: document.getElementById('maxUsage'), errorElement: errors.maxUsageError, validate: (val) => parseInt(val) >= 1 }
        ];

        function validateField(field) {
            const value = field.element.value;
            if (!field.validate(value)) {
                field.errorElement.classList.remove('hidden');
                return false;
            } else {
                field.errorElement.classList.add('hidden');
                return true;
            }
        }

        fieldsToValidate.forEach(field => {
            field.element.addEventListener('input', () => validateField(field));
            field.element.addEventListener('change', () => validateField(field));
        });

        function updateButtonState() {
            const isConsentChecked = privacyConsent.checked;
            const isFirstDiagnosisDone = sessionStorage.getItem('firstDiagnosisDone') === 'true';

            if (isConsentChecked) {
                if (isFirstDiagnosisDone) {
                    diagnoseBtn.classList.add('hidden');
                    simulateBtn.classList.remove('hidden');
                    simulateBtn.disabled = false;
                } else {
                    diagnoseBtn.classList.remove('hidden');
                    simulateBtn.classList.add('hidden');
                    diagnoseBtn.disabled = false;
                }
            } else {
                diagnoseBtn.disabled = true;
                simulateBtn.disabled = true;
            }
        }

        privacyConsent.addEventListener('change', updateButtonState);
        updateButtonState();

        category.addEventListener('change', () => {
            const placeholders = {
                ìŒì‹: 'í•œì‹, ì¹˜í‚¨, ì¤‘êµ­ìŒì‹, ì¹´í˜, ì œë¹µ',
                ì†Œë§¤: 'í¸ì˜ì , ë¬´ì¸ ì•„ì´ìŠ¤í¬ë¦¼, íœ´ëŒ€í° ê°€ê²Œ, ì˜·ê°€ê²Œ, ê½ƒê°€ê²Œ',
                êµìœ¡: 'ì˜ì–´ í•™ì›, í”¼ì•„ë…¸ í•™ì›, ë°œë ˆ í•™ì›',
                ìˆ™ë°•: 'íœì…˜, ê²ŒìŠ¤íŠ¸ í•˜ìš°ìŠ¤, ëª¨í…”',
                ë³‘ì˜ì›: 'ì´ë¹„ì¸í›„ê³¼, ì¹˜ê³¼, ì†Œì•„ê³¼, í•œì˜ì›, ì•½êµ­',
                ê¸°íƒ€: 'ë¶€ë™ì‚° ì¤‘ê°œ, ë¯¸ìš©ì‹¤, ë¬´ì¸ ì„¸íƒì†Œ'
            };
            if (category.value) {
                subDiv.classList.remove('hidden');
                subInput.placeholder = placeholders[category.value] || '';
            } else {
                subDiv.classList.add('hidden');
                subInput.value = '';
            }
            validateField(fieldsToValidate[0]);
            if (!category.value) {
                errors.subcategoryError.classList.add('hidden');
            } else {
                validateField(fieldsToValidate[1]);
            }
        });

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        async function diagnose(isSimulation = false) {
            if (!privacyConsent.checked) {
                alert('ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ ì§„ë‹¨ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            let allFieldsValid = true;
            fieldsToValidate.forEach(field => {
                if (!validateField(field)) {
                    allFieldsValid = false;
                }
            });

            if (!allFieldsValid) {
                alert('í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì±„ì›Œì£¼ì„¸ìš”.');
                return;
            }

            const categoryVal = category.value.trim();
            const subcategoryVal = subInput.value.trim();
            const area = parseInt(document.getElementById('area').value);
            const contract = parseInt(document.getElementById('contractPower').value);
            const maxUsage = parseInt(document.getElementById('maxUsage').value);
            const is24h = document.getElementById('is24h').checked;
            const diagnoseClickTime = Date.now();

            const divisor = is24h ? 720 : 450;
            const calculatedRaw = maxUsage / divisor;
            const calculatedCeiled = Math.ceil(calculatedRaw);

            let initialRecommendedPower = calculatedCeiled + 2;
            let finalRecommendedPower = initialRecommendedPower;
            let minPowerNote = '';

            if (initialRecommendedPower < 5) {
                finalRecommendedPower = 5;
                minPowerNote = `(ìµœì†Œ ê³„ì•½ì „ë ¥ì€ 5kW ì ìš©)`;
            }

            const diffForJudgment = contract - calculatedCeiled;
            const diffForFeeCalculation = contract - finalRecommendedPower;

            const feePerKw = 6160;

            let judgment = '', message = '', feeText = '', caution = '', note = '';
            let displayedPowerText = '';
            let displayedPowerValue = 0;

            let detailsHtmlContent = `
                â–· ìµœì†Œ ê³„ì•½ì „ë ¥ ê³„ì‚°ì‹<br/>
                &nbsp;&nbsp;&nbsp;&nbsp;${numberWithCommas(maxUsage)}kWh Ã· ${divisor}ì‹œê°„ = ${calculatedRaw.toFixed(2)} â‰’ <strong>${calculatedCeiled}kW</strong><br>
                â–· í˜„ì¬ ê³„ì•½ì „ë ¥: <strong>${contract}kW</strong><br>
            `;

            if (diffForJudgment < 0) {
                judgment = '<span class="warning">ë¶€ì¡±</span>';
                const increase = Math.abs(diffForFeeCalculation) * feePerKw;
                feeText = `ê°€ì‚°ê¸ˆ ì²­êµ¬ ë° ì „ë ¥ ì°¨ë‹¨ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.<br/><strong>${finalRecommendedPower}kW</strong>ë¡œ ë³€ê²½ ì‹œ ì›” ê¸°ë³¸ìš”ê¸ˆì´ <strong>${numberWithCommas(increase)}ì› ì¦ê°€</strong>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.';
                caution = '<div class="hint" id="cautionMsg">âš ï¸ ê³„ì•½ì „ë ¥ì„ ë³€ê²½ í›„ 1ë…„ ì´ë‚´ì—ëŠ” íŠ¹ë³„í•œ ì‚¬ì •ì´ ì—†ëŠ” í•œ ê°ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.</div>';
                displayedPowerText = 'ì¶”ì²œ ê³„ì•½ì „ë ¥';
                displayedPowerValue = finalRecommendedPower;

                detailsHtmlContent += `
                    â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ : ${calculatedCeiled}kW + 2kW(ì—¬ìœ ) ${initialRecommendedPower !== finalRecommendedPower ? 'â‰’' : '='} <strong>${finalRecommendedPower}kW</strong><br>
                    ${minPowerNote ? `&nbsp;&nbsp;&nbsp;&nbsp;${minPowerNote}<br>` : ''}
                    â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ê³¼ ì°¨ì´<br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;${contract}kW - ${finalRecommendedPower}kW = <strong>${diffForFeeCalculation}kW</strong><br>
                    â–· ì›”ê°„ ê¸°ë³¸ìš”ê¸ˆ ì°¨ì´<br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;${numberWithCommas(feePerKw)}ì› Ã— ${Math.abs(diffForFeeCalculation)}kW = <strong>${numberWithCommas(Math.abs(diffForFeeCalculation) * feePerKw)}ì›</strong>
                `;

            } else if (diffForJudgment >= 0 && diffForJudgment <= 2) {
                judgment = '<span class="warning">ì ì •</span>';
                if (contract !== calculatedCeiled) {
                    feeText = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ì ì ˆí•œ ì—¬ìœ ë¶„ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.';
                } else {
                    feeText = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ìµœì†Œ í•„ìš”ëŸ‰ê³¼ ê°™ìŠµë‹ˆë‹¤.';
                }
                message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ì ì • ìˆ˜ì¤€ì…ë‹ˆë‹¤.';
                caution = '';
                displayedPowerText = 'ê³„ì‚°ëœ ìµœì†Œ ê³„ì•½ì „ë ¥';
                displayedPowerValue = calculatedCeiled;

            } else {
                judgment = '<span class="warning">ê³¼ë‹¤</span>';
                const saved = Math.abs(diffForFeeCalculation) * feePerKw;
                feeText = `ë¶ˆí•„ìš”í•œ ë¹„ìš©ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.<br/><strong>${finalRecommendedPower}kW</strong>ë¡œ ë³€ê²½ ì‹œ ì›” ê¸°ë³¸ìš”ê¸ˆì´ <strong>${numberWithCommas(saved)}ì› ê°ì†Œ</strong>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì´ ê³¼ë„í•˜ê²Œ ë†’ìŠµë‹ˆë‹¤.';
                caution = '<div class="hint" id="cautionMsg">âš ï¸ ê³„ì•½ì „ë ¥ì„ ë³€ê²½ í›„ 1ë…„ ì´ë‚´ì—ëŠ” íŠ¹ë³„í•œ ì‚¬ì •ì´ ì—†ëŠ” í•œ ê°ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.</div>';
                displayedPowerText = 'ì¶”ì²œ ê³„ì•½ì „ë ¥';
                displayedPowerValue = finalRecommendedPower;

                detailsHtmlContent += `
                    â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ : ${calculatedCeiled}kW + 2kW(ì—¬ìœ ) ${initialRecommendedPower !== finalRecommendedPower ? 'â‰’' : '='} <strong>${finalRecommendedPower}kW</strong><br>
                    ${minPowerNote ? `&nbsp;&nbsp;&nbsp;&nbsp;${minPowerNote}<br>` : ''}
                    â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ê³¼ ì°¨ì´<br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;${contract}kW - ${finalRecommendedPower}kW = <strong>${diffForFeeCalculation}kW</strong><br>
                    â–· ì›”ê°„ ê¸°ë³¸ìš”ê¸ˆ ì°¨ì´<br/>
                    &nbsp;&nbsp;&nbsp;&nbsp;${numberWithCommas(feePerKw)}ì› Ã— ${Math.abs(diffForFeeCalculation)}kW = <strong>${numberWithCommas(Math.abs(diffForFeeCalculation) * feePerKw)}ì›</strong>
                `;
            }

            if (contract >= 20) {
                note = '<div class="hint">âš ï¸ 20kW ì´ìƒì¼ ê²½ìš° ìµœëŒ€ ìˆ˜ìš” ì „ë ¥ ë¯¸ë°˜ì˜ ì§„ë‹¨ì…ë‹ˆë‹¤. ë³¸ ì§„ë‹¨ì€ ì‚¬ìš©ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ë³´ì¡°ì ì¸ ì°¸ê³ ë§Œ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</div>';
            } else {
                note = '';
            }

            const status = judgment.replace(/<[^>]+>/g, '');
            const costDiff = diffForFeeCalculation * feePerKw;

            resultDiv.classList.remove('hidden'); // ê²°ê³¼ divë¥¼ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
            resultDiv.innerHTML = `
                <div>â‘  í˜„ì¬ ê³„ì•½ì „ë ¥ íŒë‹¨ ê²°ê³¼ : ${judgment}</div>
                <div>â‘¡ ${displayedPowerText} : <strong>${displayedPowerValue}kW</strong></div>
                <div>â‘¢ ${message}</div>
                <div>â‘£ ${feeText}</div>
                ${caution}
                ${note}
            `;

            if (!isSimulation) {
                sessionStorage.setItem('firstDiagnosisDone', 'true');
                diagnoseBtn.classList.add('hidden');
                simulateBtn.classList.remove('hidden');
                simulateBtn.disabled = false;
            }

            detailBtn.classList.remove('hidden'); // ìƒì„¸ ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ì„ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
            detailBtn.innerText = 'ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°';
            document.getElementById('details').classList.add('hidden');

            document.getElementById('details').innerHTML = detailsHtmlContent;

            // ì§„ë‹¨ í›„ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });


            // !!!! ì¤‘ìš”: ì´ URLì„ ë‹¹ì‹ ì˜ Cloudflare Worker URLë¡œ ë³€ê²½í•˜ì„¸ìš”. !!!!
            const googleScriptURL = "https://throbbing-block-3ed5.kknnd0728.workers.dev";
            // ì´ ë¶€ë¶„ì„ ë‹¹ì‹ ì´ ë°›ì€ URLë¡œ ë³€ê²½í•˜ì„¸ìš”.

            try {
                const response = await fetch(googleScriptURL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "text/plain", // <--- ì—¬ê¸°ë¥¼ "text/plain"ìœ¼ë¡œ ìµœì¢… ë³€ê²½í•©ë‹ˆë‹¤!
                    },
                    body: JSON.stringify({ // JSON.stringifyëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                        categoryVal,
                        subcategoryVal,
                        area,
                        contract,
                        maxUsage,
                        is24h,
                        recommendedPower: finalRecommendedPower,
                        diff: diffForFeeCalculation, 
                        status,
                        costDiff: costDiff,
                        userAgent: navigator.userAgent,
                        sessionId: currentSessionId,
                        inputStartTime: new Date(inputStartTime).toISOString(),
                        diagnoseClickTime: new Date(diagnoseClickTime).toISOString(),
                        isSimulation: isSimulation,
                        memo: ""
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData}`);
                }

                const resultText = await response.text();
                console.log("ë°ì´í„° ì „ì†¡ ì„±ê³µ:", resultText);

            } catch (error) {
                console.error("ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨:", error);
                alert('ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì½˜ì†” ë¡œê·¸ í™•ì¸ í•„ìš”)');
            }
        }

        detailBtn.addEventListener('click', () => {
            const details = document.getElementById('details');
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                detailBtn.innerText = 'ğŸ”½ ê³„ì‚° ê²°ê³¼ ìˆ¨ê¸°ê¸°';
                // ìƒì„¸ë³´ê¸°ë¥¼ ì—´ ë•Œ ìŠ¤í¬ë¡¤
                setTimeout(() => {
                    details.scrollIntoView({ behavior: 'smooth', block: 'end' }); // <-- ì—¬ê¸°ë¥¼ 'end'ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
                }, 50); // 50ms ì§€ì—°
            } else {
                details.classList.add('hidden');
                detailBtn.innerText = 'ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°';
            }
        });

        diagnoseBtn.addEventListener('click', () => diagnose(false));
        simulateBtn.addEventListener('click', () => diagnose(true));

        // --- START: Added Code for Enter Key Navigation ---
        const formElementsForEnterNav = [
            document.getElementById('category'),
            document.getElementById('subcategory'),
            document.getElementById('area'),
            document.getElementById('contractPower'),
            document.getElementById('maxUsage')
        ];

        function handleEnterNavigation(event) {
            // 'Enter' í‚¤ì˜ keyCodeëŠ” 13ì…ë‹ˆë‹¤.
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault(); // ê¸°ë³¸ ë™ì‘(ì˜ˆ: í¼ ì œì¶œ) ë°©ì§€

                const currentElement = event.target;
                const subcategoryDiv = document.getElementById('subcategoryDiv');

                // ë‚´ë¹„ê²Œì´ì…˜ ìˆœì„œë¥¼ ì •ì˜í•˜ê³ , 'ì„¸ë¶€ ì—…ì¢…'ì´ ë³´ì¼ ë•Œë§Œ ë™ì ìœ¼ë¡œ í¬í•¨í•©ë‹ˆë‹¤.
                const navigationOrder = [
                    document.getElementById('category'),
                    ...(subcategoryDiv.classList.contains('hidden') ? [] : [document.getElementById('subcategory')]),
                    document.getElementById('area'),
                    document.getElementById('contractPower'),
                    document.getElementById('maxUsage'),
                    document.getElementById('privacyConsent') // ìµœì¢… ëª©ì ì§€
                ];

                const currentIndex = navigationOrder.indexOf(currentElement);

                // í˜„ì¬ ìš”ì†Œë¥¼ ì°¾ì•˜ê³  ë§ˆì§€ë§‰ì´ ì•„ë‹ˆë¼ë©´ ë‹¤ìŒ ìš”ì†Œë¡œ í¬ì»¤ìŠ¤ë¥¼ ì´ë™í•©ë‹ˆë‹¤.
                if (currentIndex > -1 && currentIndex < navigationOrder.length - 1) {
                    const nextElement = navigationOrder[currentIndex + 1];
                    if (nextElement) {
                        nextElement.focus();
                    }
                }
            }
        }

        // ê´€ë ¨ëœ ëª¨ë“  í¼ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        formElementsForEnterNav.forEach(element => {
            element.addEventListener('keydown', handleEnterNavigation);
        });
        // --- END: Added Code for Enter Key Navigation ---

        updateButtonState();
    </script>
</body>
</html>