<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê³„ì•½ì „ë ¥ ì§„ë‹¨ê¸°</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 16px;
      margin: 0;
      background-color: #f4f4f4;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 16px;
      position: relative;
    }
    label {
      font-weight: bold;
      display: inline-block;
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="number"], 
    select {
      width: 100%;
      padding: 10px 36px 10px 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
    }
    .unit {
      position: absolute;
      right: 10px;
      top: 38px;
      font-size: 0.85em;
      color: #666;
      pointer-events: none;
      user-select: none;
    }
    .inline-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
    }
    .hint {
      color: #d33;
      font-size: 0.85em;
      margin-top: 4px;
    }
    .hidden {
      display: none;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      font-size: 0.95em;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .result, .details {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      word-break: break-word;
    }
    .warning {
      color: red;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .disclaimer {
      font-size: 0.8em;
      color: #666;
      margin-top: 20px;
      margin-bottom: 20px;
      padding: 12px 15px;
      background-color: #fffbe6;
      border: 1px solid #ffe88a;
      border-radius: 8px;
      text-align: center;
      line-height: 1.4;
    }
    .disclaimer strong {
      color: #d33;
    }
    .checkbox-container {
      margin-top: 0px; 
      margin-bottom: 16px; 
    }
    label.checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      font-weight: normal;
    }
    .info-note {
      font-size: 0.75em;
      color: #888;
      margin-top: 40px;
      text-align: center;
      user-select: none;
    }
    .consent-group {
        margin-top: 20px;
        background-color: #e9e9e9;
        padding: 12px;
        border-radius: 8px;
        font-size: 0.9em;
        line-height: 1.5;
        color: #555;
    }
    .consent-group label {
        font-weight: normal;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        cursor: pointer;
        margin-top: 10px;
    }
    .consent-group input[type="checkbox"] {
        margin-top: 3px;
        width: auto;
        flex-shrink: 0;
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      input[type="text"],
      input[type="number"], 
      select {
        padding: 10px 30px 10px 10px;
      }
      .unit {
        top: 36px;
        font-size: 0.8em;
        right: 8px;
      }
      button {
        font-size: 0.9em;
      }
      .checkbox-container {
        margin-top: 0px; 
        margin-bottom: 12px; 
      }
      label.checkbox-label {
        font-size: 0.9em;
        gap: 4px;
      }
      .disclaimer {
        margin-top: 15px;
        margin-bottom: 15px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>âš¡ ê³„ì•½ì „ë ¥ ì§„ë‹¨ê¸°</h1>
  <div class="disclaimer">
    <strong>ğŸš¨ ë³¸ ì§„ë‹¨ê¸°ëŠ” í•œì „(í•œêµ­ì „ë ¥ê³µì‚¬)ì˜ ê³µì‹ ì„œë¹„ìŠ¤ê°€ ì•„ë‹™ë‹ˆë‹¤.</strong><br>
    ì œê³µë˜ëŠ” ì •ë³´ëŠ” ë‹¨ìˆœ ì°¸ê³ ìš©ì´ë©°, ê³„ì•½ì „ë ¥ ë³€ê²½ì€ ë°˜ë“œì‹œ ì „ë¬¸ê°€ì™€ ìƒë‹´ í›„ ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.<br>
    ì´ìš©ìœ¼ë¡œ ë°œìƒí•˜ëŠ” í”¼í•´ì— ëŒ€í•´ ê°œë°œìëŠ” ì±…ì„ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
  </div>
  <div class="form-group">
    <label for="category">ì—…ì¢… ë¶„ë¥˜ <span style="color:red;">*</span></label>
    <select id="category" aria-required="true">
      <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
      <option value="ìŒì‹">ìŒì‹</option>
      <option value="ì†Œë§¤">ì†Œë§¤</option>
      <option value="êµìœ¡">êµìœ¡</option>
      <option value="ìˆ™ë°•">ìˆ™ë°•</option>
      <option value="ë³‘ì˜ì›">ë³‘ì˜ì›</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    <div class="hint hidden" id="categoryError">ì—…ì¢… ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
  </div>
  <div class="form-group hidden" id="subcategoryDiv">
    <label for="subcategory">ì„¸ë¶€ ì—…ì¢… <span style="color:red;">*</span></label>
    <input type="text" id="subcategory" placeholder="í•œì‹, ì¹˜í‚¨, ì¹´í˜ ë“±" aria-required="true" />
    <div class="hint hidden" id="subcategoryError">ì„¸ë¶€ ì—…ì¢…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
  </div>
  <div class="form-group">
    <label for="area">í‰ìˆ˜ <span style="color:red;">*</span></label>
    <input type="number" id="area" placeholder="ì˜ˆì‹œ: 13" aria-required="true" min="1" inputmode="numeric" pattern="[0-9]*"/>
    <span class="unit">í‰</span>
    <div class="hint hidden" id="areaError">í‰ìˆ˜ë¥¼ 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
  </div>
  <div class="form-group">
    <label for="contractPower">í˜„ì¬ ê³„ì•½ ì „ë ¥ <span style="color:red;">*</span></label>
    <input type="number" id="contractPower" placeholder="ì˜ˆì‹œ: 9" aria-required="true" min="1" inputmode="numeric" pattern="[0-9]*"/>
    <span class="unit">kW</span>
    <div class="hint hidden" id="contractPowerError">ê³„ì•½ ì „ë ¥ì„ 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
  </div>
  
  <div id="is24hContainer" class="checkbox-container">
    <label for="is24h" class="checkbox-label">
      <input type="checkbox" id="is24h" />
      <span><strong>ğŸ’¡24ì‹œê°„ ìš´ì˜ ì‹œ ì²´í¬</strong> (ì›” 720ì‹œê°„ ê³„ì‚°)</span>
    </label>
  </div>

  <div class="form-group">
    <label for="maxUsage">ì—°ì¤‘ ìµœëŒ€ ì‚¬ìš© ì›” ì „ë ¥ëŸ‰ <span style="color:red;">*</span></label>
    <input type="number" id="maxUsage" placeholder="ì˜ˆì‹œ: 4000" aria-required="true" min="1" inputmode="numeric" pattern="[0-9]*"/>
    <span class="unit">kWh</span>
    <div class="hint hidden" id="maxUsageError">ìµœëŒ€ ì‚¬ìš©ëŸ‰ì„ 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
  </div>
  
  <div class="consent-group">
    <p>ë³¸ ì„œë¹„ìŠ¤ëŠ” í†µê³„ ë¶„ì„ ë° ì„œë¹„ìŠ¤ ê°œì„ ì„ ìœ„í•´ ì‚¬ìš©ìì˜ ì…ë ¥ ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤. ìˆ˜ì§‘ë˜ëŠ” ì •ë³´ëŠ” ì—…ì¢… ë¶„ë¥˜, í‰ìˆ˜, ê³„ì•½ ì „ë ¥, ìµœëŒ€ ì „ë ¥ëŸ‰, 24ì‹œê°„ ìš´ì˜ ì—¬ë¶€ ë“±ì´ë©°, ê°œì¸ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì •ë³´ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    <label for="privacyConsent">
      <input type="checkbox" id="privacyConsent" />
      <span>ìœ„ ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
    </label>
  </div>

  <button id="diagnoseBtn">ğŸ“Š ì§„ë‹¨í•˜ê¸°</button>
  <button id="simulateBtn" class="hidden">ğŸ”„ ì¡°ê±´ ë³€ê²½ í›„ ì¬ì§„ë‹¨</button>

  <div class="result hidden" id="result" role="region" aria-live="polite" aria-atomic="true"></div>
  <button class="hidden" id="detailBtn">ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°</button>
  <div class="details hidden" id="details"></div>
  <div class="info-note hidden"></div>
  <script>
    const category = document.getElementById('category');
    const subDiv = document.getElementById('subcategoryDiv');
    const subInput = document.getElementById('subcategory');
    const diagnoseBtn = document.getElementById('diagnoseBtn');
    const simulateBtn = document.getElementById('simulateBtn');
    const privacyConsent = document.getElementById('privacyConsent');
    const detailBtn = document.getElementById('detailBtn');

    const inputStartTime = Date.now();

    function getSessionId() {
        let sessionId = sessionStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = Math.random().toString(36).substring(2) + Date.now().toString(36);
            sessionStorage.setItem('sessionId', sessionId);
        }
        return sessionId;
    }
    const currentSessionId = getSessionId();

    const errors = {
      categoryError: document.getElementById('categoryError'),
      subcategoryError: document.getElementById('subcategoryError'),
      areaError: document.getElementById('areaError'),
      contractPowerError: document.getElementById('contractPowerError'),
      maxUsageError: document.getElementById('maxUsageError')
    };

    const fieldsToValidate = [
      { element: category, errorElement: errors.categoryError, validate: (val) => val.trim() !== '' },
      { element: subInput, errorElement: errors.subcategoryError, validate: (val) => !subDiv.classList.contains('hidden') ? val.trim() !== '' : true },
      { element: document.getElementById('area'), errorElement: errors.areaError, validate: (val) => parseInt(val) >= 1 },
      { element: document.getElementById('contractPower'), errorElement: errors.contractPowerError, validate: (val) => parseInt(val) >= 1 },
      { element: document.getElementById('maxUsage'), errorElement: errors.maxUsageError, validate: (val) => parseInt(val) >= 1 }
    ];

    function validateField(field) {
      const value = field.element.value;
      if (!field.validate(value)) {
        field.errorElement.classList.remove('hidden');
        return false;
      } else {
        field.errorElement.classList.add('hidden');
        return true;
      }
    }

    fieldsToValidate.forEach(field => {
      field.element.addEventListener('input', () => validateField(field));
      field.element.addEventListener('change', () => validateField(field));
    });

    function updateButtonState() {
        const isConsentChecked = privacyConsent.checked;
        const isFirstDiagnosisDone = sessionStorage.getItem('firstDiagnosisDone') === 'true';

        if (isConsentChecked) {
            if (isFirstDiagnosisDone) {
                diagnoseBtn.classList.add('hidden');
                simulateBtn.classList.remove('hidden');
                simulateBtn.disabled = false;
            } else {
                diagnoseBtn.classList.remove('hidden');
                simulateBtn.classList.add('hidden');
                diagnoseBtn.disabled = false;
            }
        } else {
            diagnoseBtn.disabled = true;
            simulateBtn.disabled = true;
        }
    }

    privacyConsent.addEventListener('change', updateButtonState);
    updateButtonState();

    category.addEventListener('change', () => {
      const placeholders = {
        ìŒì‹: 'í•œì‹, ì¹˜í‚¨, ì¤‘êµ­ìŒì‹, ì¹´í˜, ì œë¹µ',
        ì†Œë§¤: 'í¸ì˜ì , ë¬´ì¸ ì•„ì´ìŠ¤í¬ë¦¼, íœ´ëŒ€í° ê°€ê²Œ, ì˜·ê°€ê²Œ, ê½ƒê°€ê²Œ',
        êµìœ¡: 'ì˜ì–´ í•™ì›, í”¼ì•„ë…¸ í•™ì›, ë°œë ˆ í•™ì›',
        ìˆ™ë°•: 'íœì…˜, ê²ŒìŠ¤íŠ¸ í•˜ìš°ìŠ¤, ëª¨í…”',
        ë³‘ì˜ì›: 'ì´ë¹„ì¸í›„ê³¼, ì¹˜ê³¼, ì†Œì•„ê³¼, í•œì˜ì›, ì•½êµ­',
        ê¸°íƒ€: 'ë¶€ë™ì‚° ì¤‘ê°œ, ë¯¸ìš©ì‹¤, ë¬´ì¸ ì„¸íƒì†Œ'
      };
      if (category.value) {
        subDiv.classList.remove('hidden');
        subInput.placeholder = placeholders[category.value] || '';
      } else {
        subDiv.classList.add('hidden');
        subInput.value = ''; 
      }
      validateField(fieldsToValidate[0]);
      if (!category.value) { 
        errors.subcategoryError.classList.add('hidden');
      } else {
        validateField(fieldsToValidate[1]);
      }
    });

    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    async function diagnose(isSimulation = false) { // async í‚¤ì›Œë“œ ì¶”ê°€
      if (!privacyConsent.checked) {
        alert('ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ ì§„ë‹¨ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      let allFieldsValid = true;
      fieldsToValidate.forEach(field => {
        if (!validateField(field)) {
          allFieldsValid = false;
        }
      });

      if (!allFieldsValid) {
        alert('í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì±„ì›Œì£¼ì„¸ìš”.'); 
        return; 
      }

      const categoryVal = category.value.trim();
      const subcategoryVal = subInput.value.trim();
      const area = parseInt(document.getElementById('area').value);
      const contract = parseInt(document.getElementById('contractPower').value);
      const maxUsage = parseInt(document.getElementById('maxUsage').value);
      const is24h = document.getElementById('is24h').checked;
      const diagnoseClickTime = Date.now();

      const divisor = is24h ? 720 : 450;
      const calculatedRaw = maxUsage / divisor; 
      const calculatedCeiled = Math.ceil(calculatedRaw); 
      
      let initialRecommendedPower = calculatedCeiled + 2; 
      let finalRecommendedPower = initialRecommendedPower; 
      let minPowerNote = ''; 

      if (initialRecommendedPower < 5) { 
          finalRecommendedPower = 5;
          minPowerNote = `(ìµœì†Œ ê³„ì•½ì „ë ¥ì€ 5kW ì ìš©)`; 
      }
      
      const diffForJudgment = contract - calculatedCeiled; 
      const diffForFeeCalculation = contract - finalRecommendedPower; 

      const feePerKw = 6160;

      let judgment = '', message = '', feeText = '', caution = '', note = '';
      let displayedPowerText = ''; 
      let displayedPowerValue = 0; 

      let detailsHtmlContent = `
        â–· ìµœì†Œ ê³„ì•½ì „ë ¥ ê³„ì‚°ì‹<br/>
        &nbsp;&nbsp;&nbsp;&nbsp;${numberWithCommas(maxUsage)}kWh Ã· ${divisor}ì‹œê°„ = ${calculatedRaw.toFixed(2)} â‰’ <strong>${calculatedCeiled}kW</strong><br>
        â–· í˜„ì¬ ê³„ì•½ì „ë ¥: <strong>${contract}kW</strong><br>
      `;

      if (diffForJudgment < 0) { 
        judgment = '<span class="warning">ë¶€ì¡±</span>';
        const increase = Math.abs(diffForFeeCalculation) * feePerKw; 
        feeText = `ê°€ì‚°ê¸ˆ ì²­êµ¬ ë° ì „ë ¥ ì°¨ë‹¨ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.<br/><strong>${finalRecommendedPower}kW</strong>ë¡œ ë³€ê²½ ì‹œ ì›” ê¸°ë³¸ìš”ê¸ˆì´ <strong>${numberWithCommas(increase)}ì› ì¦ê°€</strong>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.';
        caution = '<div class="hint" id="cautionMsg">âš ï¸ ê³„ì•½ì „ë ¥ì„ ë³€ê²½ í›„ 1ë…„ ì´ë‚´ì—ëŠ” íŠ¹ë³„í•œ ì‚¬ì •ì´ ì—†ëŠ” í•œ ê°ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.</div>';
        displayedPowerText = 'ì¶”ì²œ ê³„ì•½ì „ë ¥';
        displayedPowerValue = finalRecommendedPower; 
        
        detailsHtmlContent += `
          â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ : ${calculatedCeiled}kW + 2kW(ì—¬ìœ ) ${initialRecommendedPower !== finalRecommendedPower ? 'â‰’' : '='} <strong>${finalRecommendedPower}kW</strong><br>
          ${minPowerNote ? `&nbsp;&nbsp;&nbsp;&nbsp;${minPowerNote}<br>` : ''}
          â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ê³¼ ì°¨ì´<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;${contract}kW - ${finalRecommendedPower}kW = <strong>${diffForFeeCalculation}kW</strong><br>
          â–· ì›”ê°„ ê¸°ë³¸ìš”ê¸ˆ ì°¨ì´<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;${numberWithCommas(feePerKw)}ì› Ã— ${Math.abs(diffForFeeCalculation)}kW = <strong>${numberWithCommas(Math.abs(diffForFeeCalculation) * feePerKw)}ì›</strong>
        `;

      } else if (diffForJudgment >= 0 && diffForJudgment <= 2) {
        judgment = '<span class="warning">ì ì •</span>';
        if (contract !== calculatedCeiled) {
            feeText = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ì ì ˆí•œ ì—¬ìœ ë¶„ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.';
        } else {
            feeText = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ìµœì†Œ í•„ìš”ëŸ‰ê³¼ ê°™ìŠµë‹ˆë‹¤.'; 
        }
        message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ì ì • ìˆ˜ì¤€ì…ë‹ˆë‹¤.';
        caution = '';
        displayedPowerText = 'ê³„ì‚°ëœ ìµœì†Œ ê³„ì•½ì „ë ¥'; 
        displayedPowerValue = calculatedCeiled; 
        
      } else { 
        judgment = '<span class="warning">ê³¼ë‹¤</span>';
        const saved = Math.abs(diffForFeeCalculation) * feePerKw; 
        feeText = `ë¶ˆí•„ìš”í•œ ë¹„ìš©ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.<br/><strong>${finalRecommendedPower}kW</strong>ë¡œ ë³€ê²½ ì‹œ ì›” ê¸°ë³¸ìš”ê¸ˆì´ <strong>${numberWithCommas(saved)}ì› ê°ì†Œ</strong>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì´ ê³¼ë„í•˜ê²Œ ë†’ìŠµë‹ˆë‹¤.';
        caution = '<div class="hint" id="cautionMsg">âš ï¸ ê³„ì•½ì „ë ¥ì„ ë³€ê²½ í›„ 1ë…„ ì´ë‚´ì—ëŠ” íŠ¹ë³„í•œ ì‚¬ì •ì´ ì—†ëŠ” í•œ ê°ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.</div>';
        displayedPowerText = 'ì¶”ì²œ ê³„ì•½ì „ë ¥';
        displayedPowerValue = finalRecommendedPower; 
        
        detailsHtmlContent += `
          â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ : ${calculatedCeiled}kW + 2kW(ì—¬ìœ ) ${initialRecommendedPower !== finalRecommendedPower ? 'â‰’' : '='} <strong>${finalRecommendedPower}kW</strong><br>
          ${minPowerNote ? `&nbsp;&nbsp;&nbsp;&nbsp;${minPowerNote}<br>` : ''}
          â–· ì¶”ì²œ ê³„ì•½ì „ë ¥ê³¼ ì°¨ì´<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;${contract}kW - ${finalRecommendedPower}kW = <strong>${diffForFeeCalculation}kW</strong><br>
          â–· ì›”ê°„ ê¸°ë³¸ìš”ê¸ˆ ì°¨ì´<br/>
          &nbsp;&nbsp;&nbsp;&nbsp;${numberWithCommas(feePerKw)}ì› Ã— ${Math.abs(diffForFeeCalculation)}kW = <strong>${numberWithCommas(Math.abs(diffForFeeCalculation) * feePerKw)}ì›</strong>
        `;
      }

      if (contract >= 20) {
        note = '<div class="hint">âš ï¸ 20kW ì´ìƒì¼ ê²½ìš° ìµœëŒ€ ìˆ˜ìš” ì „ë ¥ ë¯¸ë°˜ì˜ ì§„ë‹¨ì…ë‹ˆë‹¤. ë³¸ ì§„ë‹¨ì€ ì‚¬ìš©ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ë³´ì¡°ì ì¸ ì°¸ê³ ë§Œ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</div>';
      } else {
        note = '';
      }

      const status = judgment.replace(/<[^>]+>/g, '');
      const costDiff = diffForFeeCalculation * feePerKw; 

      const result = document.getElementById('result');
      result.classList.remove('hidden');
      result.innerHTML = `
        <div>â‘  í˜„ì¬ ê³„ì•½ì „ë ¥ íŒë‹¨ ê²°ê³¼ : ${judgment}</div>
        <div>â‘¡ ${displayedPowerText} : <strong>${displayedPowerValue}kW</strong></div>
        <div>â‘¢ ${message}</div> 
        <div>â‘£ ${feeText}</div>
        ${caution}
        ${note}
      `;

      if (!isSimulation) {
          sessionStorage.setItem('firstDiagnosisDone', 'true');
          diagnoseBtn.classList.add('hidden');
          simulateBtn.classList.remove('hidden');
          simulateBtn.disabled = false;
      }

      detailBtn.classList.remove('hidden');
      detailBtn.innerText = 'ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°';
      document.getElementById('details').classList.add('hidden');
      
      document.getElementById('details').innerHTML = detailsHtmlContent;

      // !!!! ì¤‘ìš”: ì´ê³³ì— ë‹¹ì‹ ì˜ Google Apps Script ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. !!!!
      // ì´ URLì€ ë‹¹ì‹ ì˜ Google Apps Script ë°°í¬ URLì´ë©°, ì´ì „ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬í•œ URLì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
      const googleScriptURL = "https://script.google.com/macros/s/AKfycbw4DTmN9tTqs6dNGXvpmNyvLrn_jR2UnDF_qlPYiNKpZmrSdFXhbKow7t6iKvCXtoW5/exec";
        
      try {
        const response = await fetch(googleScriptURL, { // await í‚¤ì›Œë“œ ì¶”ê°€
          method: "POST",
          headers: {
            "Content-Type": "application/json", // Google Apps Scriptì—ì„œ CORSë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •í–ˆìœ¼ë¯€ë¡œ, ë‹¤ì‹œ application/jsonìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
          },
          body: JSON.stringify({
            categoryVal,
            subcategoryVal,
            area,
            contract,
            maxUsage,
            is24h,
            recommendedPower: finalRecommendedPower, 
            diff: diffForJudgment, 
            status,
            costDiff: costDiff, 
            userAgent: navigator.userAgent,
            sessionId: currentSessionId,
            inputStartTime: new Date(inputStartTime).toISOString(),
            diagnoseClickTime: new Date(diagnoseClickTime).toISOString(),
            isSimulation: isSimulation,
            memo: ""
          }),
        });

        if (!response.ok) { 
            // ì„œë²„ ì‘ë‹µì´ ì„±ê³µ(2xx)ì´ ì•„ë‹ ê²½ìš°
            const errorData = await response.text(); // í…ìŠ¤íŠ¸ë¡œ ì‘ë‹µì„ ë°›ì•„ì„œ í™•ì¸
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData}`);
        }
        
        // Google Apps Scriptì—ì„œ JSON ì‘ë‹µì„ ë³´ë‚¼ ê²½ìš°
        // const resultData = await response.json(); 
        // console.log("ë°ì´í„° ì „ì†¡ ì„±ê³µ:", resultData);

        // Google Apps Scriptì—ì„œ í…ìŠ¤íŠ¸ ì‘ë‹µì„ ë³´ë‚¼ ê²½ìš° (í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” JSONìœ¼ë¡œ ë³´ëƒ„)
        const resultText = await response.text();
        console.log("ë°ì´í„° ì „ì†¡ ì„±ê³µ:", resultText);

      } catch (error) {
        console.error("ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨:", error);
        alert('ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì½˜ì†” ë¡œê·¸ í™•ì¸ í•„ìš”)'); 
      }
    }

    detailBtn.addEventListener('click', () => {
      const details = document.getElementById('details');
      if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        detailBtn.innerText = 'ğŸ”½ ê³„ì‚° ê²°ê³¼ ìˆ¨ê¸°ê¸°';
      } else {
        details.classList.add('hidden');
        detailBtn.innerText = 'ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°';     
      }
    });

    diagnoseBtn.addEventListener('click', () => diagnose(false)); 
    simulateBtn.addEventListener('click', () => diagnose(true));

    updateButtonState();
  </script>
</body>
</html>
