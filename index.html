<!DOCTYPE html>
<html lang="ko">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>ê³„ì•½ì „ë ¥ ì§„ë‹¨ê¸°</title>
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: 'Segoe UI', sans-serif;
Â  Â  Â  padding: 16px;
Â  Â  Â  margin: 0;
Â  Â  Â  background-color: #f4f4f4;
Â  Â  Â  color: #333;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .form-group {
Â  Â  Â  margin-bottom: 16px;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  label {
Â  Â  Â  font-weight: bold;
Â  Â  Â  display: inline-block;
Â  Â  Â  margin-bottom: 4px;
Â  Â  }
Â  Â  input[type="text"],
Â  Â  input[type="number"],Â 
Â  Â  select {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px 36px 10px 10px;
Â  Â  Â  margin-top: 5px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  font-size: 1em;
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  .unit {
Â  Â  Â  position: absolute;
Â  Â  Â  right: 10px;
Â  Â  Â  top: 38px;
Â  Â  Â  font-size: 0.85em;
Â  Â  Â  color: #666;
Â  Â  Â  pointer-events: none;
Â  Â  Â  user-select: none;
Â  Â  }
Â  Â  .inline-label {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 10px;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .hint {
Â  Â  Â  color: #d33;
Â  Â  Â  font-size: 0.85em;
Â  Â  Â  margin-top: 4px;
Â  	  margin-bottom: 8px;
Â  Â  }
Â  Â  .hidden {
Â  Â  Â  display: none;
Â  	  opacity: 0;
Â  	  height: 0;
Â  	  overflow: hidden;
Â  	  transition: opacity 0.3s ease-in-out, height 0.3s ease-in-out;
Â  	  visibility: hidden;
Â  	}
Â  	.visible {
Â  	  opacity: 1;
Â  	  height: auto;
Â  	  visibility: visible;
Â  	  display: block; /* Ensure it takes up space when visible */
Â  	}
Â  	.form-group.visible { /* Specific rule for form-group to ensure block display */
Â  	  display: block;
Â  	}


Â  	button {
Â  	  background-color: #007bff;
Â  	  color: white;
Â  	  border: none;
Â  	  padding: 12px;
Â  	  width: 100%;
Â  	  font-size: 0.95em;
Â  	  border-radius: 6px;
Â  	  cursor: pointer;
Â  	  margin-top: 8px;
Â  	}
Â  	button:hover:not(:disabled) {
Â  	  background-color: #0056b3;
Â  	}
Â  	button:disabled {
Â  	  background-color: #cccccc;
Â  	  cursor: not-allowed;
Â  	}
Â  	.result, .details {
Â  	  background: white;
Â  	  padding: 16px;
Â  	  border-radius: 8px;
Â  	  margin-top: 20px;
Â  	  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
Â  	  word-break: break-word;
Â  	}
Â  	.warning {
Â  	  color: red;
Â  	  font-weight: bold;
Â  	  margin-bottom: 10px;
Â  	}
Â  	.positive { /* Added for better distinction for positive outcomes */
Â  	  color: green;
Â  	  font-weight: bold;
Â  	}
Â  	.neutral { /* Added for better distinction for neutral outcomes */
Â  	  color: blue;
Â  	  font-weight: bold;
Â  	}
Â  	
Â  	.disclaimer {
Â  	  font-size: 0.8em;
Â  	  color: #666;
Â  	  margin-top: 20px;
Â  	  margin-bottom: 20px;
Â  	  padding: 12px 15px;
Â  	  background-color: #fffbe6;
Â  	  border: 1px solid #ffe88a;
Â  	  border-radius: 8px;
Â  	  text-align: center;
Â  	  line-height: 1.4;
Â  	}
Â  	.disclaimer strong {
Â  	  color: #d33;
Â  	}
Â  	.checkbox-container {
Â  	  margin-top: 0px;Â 
Â  	  margin-bottom: 16px;Â 
Â  	}
Â  	label.checkbox-label {
Â  	  display: inline-flex;
Â  	  align-items: center;
Â  	  gap: 6px;
Â  	  white-space: nowrap;
Â  	  cursor: pointer;
Â  	  user-select: none;
Â  	  font-weight: normal;
Â  	}
Â  	.info-note {
Â  	  font-size: 0.75em;
Â  	  color: #888;
Â  	  margin-top: 40px;
Â  	  text-align: center;
Â  	  user-select: none;
Â  	}
Â  	.consent-group {
Â  	  margin-top: 20px;
Â  	  background-color: #e9e9e9;
Â  	  padding: 12px;
Â  	  border-radius: 8px;
Â  	  font-size: 0.9em;
Â  	  line-height: 1.5;
Â  	  color: #555;
Â  	}
Â  	.consent-group label {
Â  	  font-weight: normal;
Â  	  display: flex;
Â  	  align-items: flex-start;
Â  	  gap: 8px;
Â  	  cursor: pointer;
Â  	  margin-top: 10px;
Â  	}
Â  	.consent-group input[type="checkbox"] {
Â  	  margin-top: 3px;
Â  	  width: auto;
Â  	  flex-shrink: 0;
Â  	}

Â  	@media (max-width: 480px) {
Â  	  body {
Â  	    padding: 12px;
Â  	  }
Â  	  input[type="text"],
Â  	  input[type="number"],Â 
Â  	  select {
Â  	    padding: 10px 30px 10px 10px;
Â  	  }
Â  	  .unit {
Â  	    top: 36px;
Â  	    font-size: 0.8em;
Â  	    right: 8px;
Â  	  }
Â  	  button {
Â  	    font-size: 0.9em;
Â  	  }
Â  	  .checkbox-container {
Â  	    margin-top: 0px;Â 
Â  	    margin-bottom: 12px;Â 
Â  	  }
Â  	  label.checkbox-label {
Â  	    font-size: 0.9em;
Â  	    gap: 4px;
Â  	  }
Â  	  .disclaimer {
Â  	    margin-top: 15px;
Â  	    margin-bottom: 15px;
Â  	    padding: 10px;
Â  	  }
Â  	}
Â  </style>
</head>
<body>
Â  <h1>âš¡ ê³„ì•½ì „ë ¥ ì§„ë‹¨ê¸°</h1>
Â  <div class="disclaimer">
Â  Â  <strong>ğŸš¨ ë³¸ ì§„ë‹¨ê¸°ëŠ” í•œì „(í•œêµ­ì „ë ¥ê³µì‚¬)ì˜ ê³µì‹ ì„œë¹„ìŠ¤ê°€ ì•„ë‹™ë‹ˆë‹¤.</strong><br>
Â  Â  ì œê³µë˜ëŠ” ì •ë³´ëŠ” ë‹¨ìˆœ ì°¸ê³ ìš©ì´ë©°, ê³„ì•½ì „ë ¥ ë³€ê²½ì€ ë°˜ë“œì‹œ ì „ë¬¸ê°€ì™€ ìƒë‹´ í›„ ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.<br>
Â  Â  ì´ìš©ìœ¼ë¡œ ë°œìƒí•˜ëŠ” í”¼í•´ì— ëŒ€í•´ ê°œë°œìëŠ” ì±…ì„ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
Â  </div>
Â  <div class="form-group">
Â  Â  <label for="category">ì—…ì¢… ë¶„ë¥˜ <span style="color:red;">*</span></label>
Â  Â  <select id="category" aria-required="true">
Â  Â  Â  <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
Â  Â  Â  <option value="ìŒì‹">ìŒì‹</option>
Â  Â  Â  <option value="ì†Œë§¤">ì†Œë§¤</option>
Â  Â  Â  <option value="êµìœ¡">êµìœ¡</option>
Â  Â  Â  <option value="ìˆ™ë°•">ìˆ™ë°•</option>
Â  Â  Â  <option value="ë³‘ì˜ì›">ë³‘ì˜ì›</option>
Â  Â  Â  <option value="ê¸°íƒ€">ê¸°íƒ€</option>
Â  Â  </select>
Â  Â  <div class="hint hidden" id="categoryError">ì—…ì¢… ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
Â  </div>
Â  <div class="form-group hidden" id="subcategoryDiv">
Â  Â  <label for="subcategory">ì„¸ë¶€ ì—…ì¢… <span style="color:red;">*</span></label>
Â  Â  <input type="text" id="subcategory" placeholder="í•œì‹, ì¹˜í‚¨, ì¹´í˜ ë“±" aria-required="true" />
Â  Â  <div class="hint hidden" id="subcategoryError">ì„¸ë¶€ ì—…ì¢…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
Â  </div>
Â  <div class="form-group">
Â  Â  <label for="area">í‰ìˆ˜ <span style="color:red;">*</span></label>
Â  Â  <input type="number" id="area" placeholder="ì˜ˆì‹œ: 13" aria-required="true" min="1" inputmode="numeric" pattern="[0-9]*"/>
Â  Â  <span class="unit">í‰</span>
Â  Â  <div class="hint hidden" id="areaError">í‰ìˆ˜ë¥¼ 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
Â  </div>
Â  <div class="form-group">
Â  Â  <label for="contractPower">í˜„ì¬ ê³„ì•½ ì „ë ¥ <span style="color:red;">*</span></label>
Â  Â  <input type="number" id="contractPower" placeholder="ì˜ˆì‹œ: 9" aria-required="true" min="1" inputmode="numeric" pattern="[0-9]*"/>
Â  Â  <span class="unit">kW</span>
Â  Â  <div class="hint hidden" id="contractPowerError">ê³„ì•½ ì „ë ¥ì„ 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
Â  </div>
Â Â 
Â  <div id="is24hContainer" class="checkbox-container">
Â  Â  <label for="is24h" class="checkbox-label">
Â  Â  Â  <input type="checkbox" id="is24h" />
Â  Â  Â  <span><strong>ğŸ’¡24ì‹œê°„ ìš´ì˜ ì‹œ ì²´í¬</strong> (ì›” 720ì‹œê°„ ê³„ì‚°)</span>
Â  Â  </label>
Â  </div>

Â  <div class="form-group">
Â  Â  <label for="maxUsage">ì—°ì¤‘ ìµœëŒ€ ì‚¬ìš© ì›” ì „ë ¥ëŸ‰ <span style="color:red;">*</span></label>
Â  Â  <input type="number" id="maxUsage" placeholder="ì˜ˆì‹œ: 4000" aria-required="true" min="1" inputmode="numeric" pattern="[0-9]*"/>
Â  Â  <span class="unit">kWh</span>
Â  Â  <div class="hint hidden" id="maxUsageError">ìµœëŒ€ ì‚¬ìš©ëŸ‰ì„ 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
Â  </div>
Â Â 
Â  <div class="consent-group">
Â  Â  <p>ë³¸ ì„œë¹„ìŠ¤ëŠ” í†µê³„ ë¶„ì„ ë° ì„œë¹„ìŠ¤ ê°œì„ ì„ ìœ„í•´ ì‚¬ìš©ìì˜ ì…ë ¥ ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤. ìˆ˜ì§‘ë˜ëŠ” ì •ë³´ëŠ” ì—…ì¢… ë¶„ë¥˜, í‰ìˆ˜, ê³„ì•½ ì „ë ¥, ìµœëŒ€ ì „ë ¥ëŸ‰, 24ì‹œê°„ ìš´ì˜ ì—¬ë¶€ ë“±ì´ë©°, ê°œì¸ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì •ë³´ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
Â  Â  <label for="privacyConsent">
Â  Â  Â  <input type="checkbox" id="privacyConsent" />
Â  Â  Â  <span>ìœ„ ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
Â  Â  </label>
Â  </div>

Â  <button id="diagnoseBtn">ğŸ“Š ì§„ë‹¨í•˜ê¸°</button>
Â  <button id="simulateBtn" class="hidden">ğŸ”„ ì¡°ê±´ ë³€ê²½ í›„ ì¬ì§„ë‹¨</button>

Â  <div class="result hidden" id="result" role="region" aria-live="polite" aria-atomic="true"></div>
Â  <button class="hidden" id="detailBtn">ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°</button>
Â  <div class="details hidden" id="details"></div>
Â  <div class="info-note hidden"></div>
Â  <script>
Â  Â  const category = document.getElementById('category');
Â  Â  const subDiv = document.getElementById('subcategoryDiv');
Â  Â  const subInput = document.getElementById('subcategory');
Â  Â  const diagnoseBtn = document.getElementById('diagnoseBtn');
Â  Â  const simulateBtn = document.getElementById('simulateBtn');
Â  Â  const privacyConsent = document.getElementById('privacyConsent');
Â  Â  const detailBtn = document.getElementById('detailBtn');

Â  Â  const inputStartTime = Date.now();

Â  Â  function getSessionId() {
Â  Â  Â  Â  let sessionId = sessionStorage.getItem('sessionId');
Â  Â  Â  Â  if (!sessionId) {
Â  Â  Â  Â  Â  Â  sessionId = Math.random().toString(36).substring(2) + Date.now().toString(36);
Â  Â  Â  Â  Â  Â  sessionStorage.setItem('sessionId', sessionId);
Â  Â  Â  Â  }
Â  Â  Â  Â  return sessionId;
Â  Â  }
Â  Â  const currentSessionId = getSessionId();

Â  Â  const errors = {
Â  Â  Â  categoryError: document.getElementById('categoryError'),
Â  Â  Â  subcategoryError: document.getElementById('subcategoryError'),
Â  Â  Â  areaError: document.getElementById('areaError'),
Â  Â  Â  contractPowerError: document.getElementById('contractPowerError'),
Â  Â  Â  maxUsageError: document.getElementById('maxUsageError')
Â  Â  };

Â  Â  const fieldsToValidate = [
Â  Â  Â  { element: category, errorElement: errors.categoryError, validate: (val) => val.trim() !== '' },
Â  Â  Â  { element: subInput, errorElement: errors.subcategoryError, validate: (val) => !subDiv.classList.contains('hidden') ? val.trim() !== '' : true },
Â  Â  Â  { element: document.getElementById('area'), errorElement: errors.areaError, validate: (val) => parseInt(val) >= 1 },
Â  	  { element: document.getElementById('contractPower'), errorElement: errors.contractPowerError, validate: (val) => parseInt(val) >= 1 },
Â  	  { element: document.getElementById('maxUsage'), errorElement: errors.maxUsageError, validate: (val) => parseInt(val) >= 1 }
Â  	];

Â  	// Helper function to scroll to the next element
Â  	function scrollToNextElement(currentElement) {
Â  	  const allElements = Array.from(document.querySelectorAll('input, select, .checkbox-container, .consent-group, button'));
Â  	  const currentIndex = allElements.indexOf(currentElement);
Â  	  if (currentIndex > -1 && currentIndex + 1 < allElements.length) {
Â  	    let nextElement = allElements[currentIndex + 1];
Â  	    // Skip hidden elements, but not the hidden input field itself if it's part of a visible group
Â  	    while (nextElement && (nextElement.classList.contains('hidden') || nextElement.closest('.hidden')) && allElements.indexOf(nextElement) + 1 < allElements.length) {
Â  	      if (nextElement.id === 'subcategory' && !subDiv.classList.contains('hidden')) {
Â  	        break; // Keep subcategory if its div is visible
Â  	      }
Â  	      nextElement = allElements[allElements.indexOf(nextElement) + 1];
Â  	    }
Â  	    // Special handling for the diagnose button vs simulate button
Â  	    if (nextElement.id === 'diagnoseBtn' && simulateBtn.classList.contains('visible')) {
Â  	      nextElement = simulateBtn;
Â  	    } else if (nextElement.id === 'simulateBtn' && diagnoseBtn.classList.contains('visible')) {
Â  	      nextElement = diagnoseBtn;
Â  	    }

Â  	    if (nextElement && !nextElement.classList.contains('hidden')) {
Â  	      nextElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  	    }
Â  	  }
Â  	}


Â  	function validateField(field) {
Â  	  const value = field.element.value;
Â  	  if (!field.validate(value)) {
Â  	    field.errorElement.classList.remove('hidden');
Â  	    field.errorElement.classList.add('visible');
Â  	    return false;
Â  	  } else {
Â  	    field.errorElement.classList.add('hidden');
Â  	    field.errorElement.classList.remove('visible');
Â  	    return true;
Â  	  }
Â  	}

Â  	fieldsToValidate.forEach(field => {
Â  	  // Validate on input (for immediate feedback)
Â  	  field.element.addEventListener('input', () => validateField(field));
Â  	  
Â  	  // Validate and scroll on change (for select) or blur (for input)
Â  	  if (field.element.tagName === 'SELECT') {
Â  	    field.element.addEventListener('change', () => {
Â  	      if (validateField(field)) {
Â  	        if (field.element.id === 'category' && field.element.value === 'ê¸°íƒ€') {
Â  	          // If 'ê¸°íƒ€' is selected, wait for subcategory to become visible before scrolling to it
Â  	          // Or explicitly scroll to subcategory input
Â  	          setTimeout(() => {
Â  	            const subcategoryInput = document.getElementById('subcategory');
Â  	            if (subcategoryInput && !subDiv.classList.contains('hidden')) {
Â  	              subcategoryInput.focus();
Â  	              subcategoryInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  	            } else {
Â  	              scrollToNextElement(field.element);
Â  	            }
Â  	          }, 100); // Small delay to allow subcategoryDiv to render
Â  	        } else {
Â  	          scrollToNextElement(field.element);
Â  	        }
Â  	      }
Â  	    });
Â  	  } else {
Â  	    field.element.addEventListener('blur', () => {
Â  	      if (validateField(field)) {
Â  	        scrollToNextElement(field.element);
Â  	      }
Â  	    });
Â  	  }
Â  	});

Â  	// Scroll to consent group when maxUsage is done
Â  	document.getElementById('maxUsage').addEventListener('blur', () => {
Â  	  if (validateField(fieldsToValidate[4])) { // Check if maxUsage is valid
Â  	    const consentGroup = document.querySelector('.consent-group');
Â  	    if (consentGroup) {
Â  	      consentGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  	    }
Â  	  }
Â  	});

Â  	// Scroll to button when consent is checked
Â  	privacyConsent.addEventListener('change', () => {
Â  	  updateButtonState();
Â  	  if (privacyConsent.checked) {
Â  	    setTimeout(() => {
Â  	      const targetButton = diagnoseBtn.classList.contains('hidden') ? simulateBtn : diagnoseBtn;
Â  	      targetButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  	    }, 100);
Â  	  }
Â  	});

Â  	function updateButtonState() {
Â  	  const isConsentChecked = privacyConsent.checked;
Â  	  const isFirstDiagnosisDone = sessionStorage.getItem('firstDiagnosisDone') === 'true';

Â  	  if (isConsentChecked) {
Â  	    if (isFirstDiagnosisDone) {
Â  	      diagnoseBtn.classList.add('hidden');
Â  	      diagnoseBtn.classList.remove('visible');
Â  	      simulateBtn.classList.remove('hidden');
Â  	      simulateBtn.classList.add('visible');
Â  	      simulateBtn.disabled = false;
Â  	    } else {
Â  	      diagnoseBtn.classList.remove('hidden');
Â  	      diagnoseBtn.classList.add('visible');
Â  	      simulateBtn.classList.add('hidden');
Â  	      simulateBtn.classList.remove('visible');
Â  	      diagnoseBtn.disabled = false;
Â  	    }
Â  	  } else {
Â  	    diagnoseBtn.disabled = true;
Â  	    simulateBtn.disabled = true;
Â  	  }
Â  	}

Â  	privacyConsent.addEventListener('change', updateButtonState);
Â  	updateButtonState();

Â  	category.addEventListener('change', () => {
Â  	  const placeholders = {
Â  	    ìŒì‹: 'í•œì‹, ì¹˜í‚¨, ì¤‘êµ­ìŒì‹, ì¹´í˜, ì œë¹µ',
Â  	    ì†Œë§¤: 'í¸ì˜ì , ë¬´ì¸ ì•„ì´ìŠ¤í¬ë¦¼, íœ´ëŒ€í° ê°€ê²Œ, ì˜·ê°€ê²Œ, ê½ƒê°€ê²Œ',
Â  	    êµìœ¡: 'ì˜ì–´ í•™ì›, í”¼ì•„ë…¸ í•™ì›, ë°œë ˆ í•™ì›',
Â  	    ìˆ™ë°•: 'íœì…˜, ê²ŒìŠ¤íŠ¸ í•˜ìš°ìŠ¤, ëª¨í…”',
Â  	    ë³‘ì˜ì›: 'ì´ë¹„ì¸í›„ê³¼, ì¹˜ê³¼, ì†Œì•„ê³¼, í•œì˜ì›, ì•½êµ­',
Â  	    ê¸°íƒ€: 'ë¶€ë™ì‚° ì¤‘ê°œ, ë¯¸ìš©ì‹¤, ë¬´ì¸ ì„¸íƒì†Œ'
Â  	  };
Â  	  if (category.value) {
Â  	    subDiv.classList.remove('hidden');
Â  	    subDiv.classList.add('visible');
Â  	    subInput.placeholder = placeholders[category.value] || '';
Â  	  } else {
Â  	    subDiv.classList.add('hidden');
Â  	    subDiv.classList.remove('visible');
Â  	    subInput.value = '';Â 
Â  	  }
Â  	  validateField(fieldsToValidate[0]);
Â  	  if (!category.value) {Â 
Â  	    errors.subcategoryError.classList.add('hidden');
Â  	    errors.subcategoryError.classList.remove('visible');
Â  	  } else {
Â  	    validateField(fieldsToValidate[1]);
Â  	  }
Â  	});

Â  	function numberWithCommas(x) {
Â  	  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
Â  	}

Â  	async function diagnose(isSimulation = false) {Â 
Â  	  if (!privacyConsent.checked) {
Â  	    alert('ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ ì§„ë‹¨ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
Â  	    return;
Â  	  }

Â  	  let allFieldsValid = true;
Â  	  fieldsToValidate.forEach(field => {
Â  	    if (!validateField(field)) {
Â  	      allFieldsValid = false;
Â  	    }
Â  	  });

Â  	  if (!allFieldsValid) {
Â  	    alert('í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì±„ì›Œì£¼ì„¸ìš”.');Â 
Â  	    return;Â 
Â  	  }

Â  	  const categoryVal = category.value.trim();
Â  	  const subcategoryVal = subInput.value.trim();
Â  	  const area = parseInt(document.getElementById('area').value);
Â  	  const contract = parseInt(document.getElementById('contractPower').value);
Â  	  const maxUsage = parseInt(document.getElementById('maxUsage').value);
Â  	  const is24h = document.getElementById('is24h').checked;
Â  	  const diagnoseClickTime = Date.now();

Â  	  const divisor = is24h ? 720 : 450;
Â  	  const calculatedRaw = maxUsage / divisor;Â 
Â  	  const calculatedCeiled = isNaN(calculatedRaw) || calculatedRaw === 0 ? 0 : Math.ceil(calculatedRaw);Â 
Â  	  
Â  	  let initialRecommendedPower = calculatedCeiled + 2;Â 
Â  	  let finalRecommendedPower = initialRecommendedPower;Â 
Â  	  let minPowerNote = '';Â 

Â  	  if (maxUsage > 0 && initialRecommendedPower < 5) { // maxUsageê°€ 0ì´ ì•„ë‹ˆë©´ ìµœì†Œ 5kW ì ìš©
Â  	    finalRecommendedPower = 5;
Â  	    minPowerNote = `(ìµœì†Œ ê³„ì•½ì „ë ¥ì€ 5kW ì ìš©)`;Â 
Â  	  } else if (maxUsage === 0) { // maxUsageê°€ 0ì´ë©´ ì¶”ì²œ ì „ë ¥ë„ 0ìœ¼ë¡œ (ë˜ëŠ” "ì…ë ¥ í•„ìš”" ë“±ìœ¼ë¡œ í‘œì‹œ)
Â  	    finalRecommendedPower = 0;
Â  	    minPowerNote = `(ì „ë ¥ ì‚¬ìš©ëŸ‰ ì…ë ¥ í•„ìš”)`;
Â  	  }
Â  	  
Â  	  const diffForJudgment = contract - calculatedCeiled;Â 
Â  	  const diffForFeeCalculation = contract - finalRecommendedPower;Â 

Â  	  const feePerKw = 6160;

Â  	  let judgment = '', message = '', feeText = '', caution = '', note = '';
Â  	  let judgmentClass = ''; // Added for styling
Â  	  let displayedPowerText = '';Â 
Â  	  let displayedPowerValue = 0;Â 
Â  	  
Â  	  // Initial details content
Â  	  let detailsHtmlContent = `
Â  	    <h3>ê³„ì‚° ìƒì„¸ ë³´ê¸°</h3>
Â  	    <h4>ì‚¬ìš©ëŸ‰ ê¸°ë°˜ ìµœì†Œ í•„ìš” ì „ë ¥ ê³„ì‚°</h4>
Â  	    <div>ì—°ì¤‘ ìµœëŒ€ ì‚¬ìš©ëŸ‰: <strong>${numberWithCommas(maxUsage)}kWh</strong></div>
Â  	    <div>ì›” ê¸°ì¤€ ì‹œê°„: <strong>${divisor}ì‹œê°„</strong> (${is24h ? '24ì‹œê°„ ìš´ì˜' : 'ì£¼ê°„ í‰ê·  ìš´ì˜'})</div>
Â  	    <div>ê³„ì‚°ì‹: ${numberWithCommas(maxUsage)}kWh Ã· ${divisor}ì‹œê°„ = ${calculatedRaw.toFixed(2)}kW</div>
Â  	    <div>ìµœì†Œ í•„ìš” ì „ë ¥ (ì˜¬ë¦¼): <strong>${calculatedCeiled}kW</strong></div>
Â  	    <h4>ê³„ì•½ì „ë ¥ íŒë‹¨ ë° ë¹„ìš© ë¶„ì„</h4>
Â  	    <div>í˜„ì¬ ê³„ì•½ì „ë ¥: <strong>${contract}kW</strong></div>
Â  	  `;

Â  	  if (diffForJudgment < 0) {Â 
Â  	    judgment = 'ë¶€ì¡±';
Â  	    judgmentClass = 'warning';
Â  	    const increase = Math.abs(diffForFeeCalculation) * feePerKw;Â 
Â  	    feeText = `ê°€ì‚°ê¸ˆ ì²­êµ¬ ë° ì „ë ¥ ì°¨ë‹¨ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.<br/><strong>${finalRecommendedPower}kW</strong>ë¡œ ë³€ê²½ ì‹œ ì›” ê¸°ë³¸ìš”ê¸ˆì´ <strong>${numberWithCommas(increase)}ì› ì¦ê°€</strong>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
Â  	    message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.';
Â  	    caution = '<div class="hint" id="cautionMsg">âš ï¸ ê³„ì•½ì „ë ¥ì„ ë³€ê²½ í›„ 1ë…„ ì´ë‚´ì—ëŠ” íŠ¹ë³„í•œ ì‚¬ì •ì´ ì—†ëŠ” í•œ ê°ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.</div>';
Â  	    displayedPowerText = 'ì¶”ì²œ ê³„ì•½ì „ë ¥';
Â  	    displayedPowerValue = finalRecommendedPower;Â 
Â  	    Â 
Â  	    detailsHtmlContent += `
Â  	      <div>ì¶”ì²œ ê³„ì•½ì „ë ¥: ${calculatedCeiled}kW + 2kW(ì—¬ìœ ) ${initialRecommendedPower !== finalRecommendedPower && maxUsage > 0 ? 'â‰’' : '='} <strong>${finalRecommendedPower}kW</strong></div>
Â  	      ${minPowerNote ? `<div>${minPowerNote}</div>` : ''}
Â  	      <div>ì¶”ì²œ ê³„ì•½ì „ë ¥ê³¼ ì°¨ì´: ${contract}kW - ${finalRecommendedPower}kW = <strong>${diffForFeeCalculation}kW</strong></div>
Â  	      <div>ì›”ê°„ ê¸°ë³¸ìš”ê¸ˆ ì°¨ì´: ${numberWithCommas(feePerKw)}ì› Ã— ${Math.abs(diffForFeeCalculation)}kW = <strong>${numberWithCommas(Math.abs(diffForFeeCalculation) * feePerKw)}ì›</strong></div>
Â  	    `;

Â  	  } else if (diffForJudgment >= 0 && diffForJudgment <= 2) {
Â  	    judgment = 'ì ì •';
Â  	    judgmentClass = 'neutral';
Â  	    if (contract !== calculatedCeiled) {
Â  	        feeText = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ì ì ˆí•œ ì—¬ìœ ë¶„ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.';
Â  	    } else {
Â  	        feeText = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ìµœì†Œ í•„ìš”ëŸ‰ê³¼ ê°™ìŠµë‹ˆë‹¤.';Â 
Â  	    }
Â  	    message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì€ ì ì • ìˆ˜ì¤€ì…ë‹ˆë‹¤.';
Â  	    caution = '';
Â  	    displayedPowerText = 'ê³„ì‚°ëœ ìµœì†Œ ê³„ì•½ì „ë ¥';Â 
Â  	    displayedPowerValue = calculatedCeiled;Â 
Â  	    Â 
Â  	  } else {Â 
Â  	    judgment = 'ê³¼ë‹¤';
Â  	    judgmentClass = 'positive';
Â  	    const saved = Math.abs(diffForFeeCalculation) * feePerKw;Â 
Â  	    feeText = `ë¶ˆí•„ìš”í•œ ë¹„ìš©ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.<br/><strong>${finalRecommendedPower}kW</strong>ë¡œ ë³€ê²½ ì‹œ ì›” ê¸°ë³¸ìš”ê¸ˆì´ <strong>${numberWithCommas(saved)}ì› ê°ì†Œ</strong>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
Â  	    message = 'í˜„ì¬ ê³„ì•½ ì „ë ¥ì´ ê³¼ë„í•˜ê²Œ ë†’ìŠµë‹ˆë‹¤.';
Â  	    caution = '<div class="hint" id="cautionMsg">âš ï¸ ê³„ì•½ì „ë ¥ì„ ë³€ê²½ í›„ 1ë…„ ì´ë‚´ì—ëŠ” íŠ¹ë³„í•œ ì‚¬ì •ì´ ì—†ëŠ” í•œ ê°ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘íˆ ê²°ì •í•˜ì„¸ìš”.</div>';
Â  	    displayedPowerText = 'ì¶”ì²œ ê³„ì•½ì „ë ¥';
Â  	    displayedPowerValue = finalRecommendedPower;Â 
Â  	    Â 
Â  	    detailsHtmlContent += `
Â  	      <div>ì¶”ì²œ ê³„ì•½ì „ë ¥: ${calculatedCeiled}kW + 2kW(ì—¬ìœ ) ${initialRecommendedPower !== finalRecommendedPower && maxUsage > 0 ? 'â‰’' : '='} <strong>${finalRecommendedPower}kW</strong></div>
Â  	      ${minPowerNote ? `<div>${minPowerNote}</div>` : ''}
Â  	      <div>ì¶”ì²œ ê³„ì•½ì „ë ¥ê³¼ ì°¨ì´: ${contract}kW - ${finalRecommendedPower}kW = <strong>${diffForFeeCalculation}kW</strong></div>
Â  	      <div>ì›”ê°„ ê¸°ë³¸ìš”ê¸ˆ ì°¨ì´: ${numberWithCommas(feePerKw)}ì› Ã— ${Math.abs(diffForFeeCalculation)}kW = <strong>${numberWithCommas(Math.abs(diffForFeeCalculation) * feePerKw)}ì›</strong></div>
Â  	    `;
Â  	  }

Â  	  if (contract >= 20) {
Â  	    note = '<div class="hint">âš ï¸ 20kW ì´ìƒì¼ ê²½ìš° ìµœëŒ€ ìˆ˜ìš” ì „ë ¥ ë¯¸ë°˜ì˜ ì§„ë‹¨ì…ë‹ˆë‹¤. ë³¸ ì§„ë‹¨ì€ ì‚¬ìš©ëŸ‰ ê¸°ì¤€ìœ¼ë¡œ ë³´ì¡°ì ì¸ ì°¸ê³ ë§Œ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</div>';
Â  	  } else {
Â  	    note = '';
Â  	  }

Â  	  const status = judgment; // Use raw judgment for logging
Â  	  const costDiff = diffForFeeCalculation * feePerKw;Â 

Â  	  const result = document.getElementById('result');
Â  	  result.classList.remove('hidden');
Â  	  result.classList.add('visible');
Â  	  result.innerHTML = `
Â  	    <div>â‘  í˜„ì¬ ê³„ì•½ì „ë ¥ íŒë‹¨ ê²°ê³¼ : <strong class="${judgmentClass}">${judgment}</strong></div>
Â  	    <div>â‘¡ ${displayedPowerText} : <strong>${displayedPowerValue}kW</strong></div>
Â  	    <div>â‘¢ ${message}</div>Â 
Â  	    <div>â‘£ ${feeText}</div>
Â  	    ${caution}
Â  	    ${note}
Â  	  `;

Â  	  // **ì§„ë‹¨ í›„ ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™**
Â  	  result.scrollIntoView({ behavior: 'smooth', block: 'start' });


Â  	  if (!isSimulation) {
Â  	    sessionStorage.setItem('firstDiagnosisDone', 'true');
Â  	    diagnoseBtn.classList.add('hidden');
Â  	    diagnoseBtn.classList.remove('visible');
Â  	    simulateBtn.classList.remove('hidden');
Â  	    simulateBtn.classList.add('visible');
Â  	    simulateBtn.disabled = false;
Â  	  }

Â  	  detailBtn.classList.remove('hidden');
Â  	  detailBtn.classList.add('visible');
Â  	  detailBtn.innerText = 'ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°';
Â  	  document.getElementById('details').classList.add('hidden');
Â  	  document.getElementById('details').classList.remove('visible');
Â  	  Â 
Â  	  document.getElementById('details').innerHTML = detailsHtmlContent;

Â  	  // !!!! ì¤‘ìš”: ì´ URLì„ ë‹¹ì‹ ì˜ Cloudflare Worker URLë¡œ ë³€ê²½í•˜ì„¸ìš”. !!!!
Â  	  const googleScriptURL = "https://throbbing-block-3ed5.kknnd0728.workers.dev";Â 
Â  	  // ì´ ë¶€ë¶„ì„ ë‹¹ì‹ ì´ ë°›ì€ URLë¡œ ë³€ê²½í•˜ì„¸ìš”.
Â  	  Â 
Â  	  try {
Â  	    const response = await fetch(googleScriptURL, {Â 
Â  	      method: "POST",
Â  	      headers: {
Â  	        "Content-Type": "text/plain",
Â  	      },
Â  	      body: JSON.stringify({
Â  	        categoryVal,
Â  	        subcategoryVal,
Â  	        area,
Â  	        contract,
Â  	        maxUsage,
Â  	        is24h,
Â  	        recommendedPower: finalRecommendedPower,Â 
Â  	        diff: diffForJudgment,Â 
Â  	        status: status.replace(/<[^>]+>/g, ''), // Remove HTML tags for logging
Â  	        costDiff: costDiff,Â 
Â  	        userAgent: navigator.userAgent,
Â  	        sessionId: currentSessionId,
Â  	        inputStartTime: new Date(inputStartTime).toISOString(),
Â  	        diagnoseClickTime: new Date(diagnoseClickTime).toISOString(),
Â  	        isSimulation: isSimulation,
Â  	        memo: ""
Â  	      }),
Â  	    });

Â  	    if (!response.ok) {Â 
Â  	        const errorData = await response.text();Â 
Â  	        throw new Error(`HTTP error! status: ${response.status}, message: ${errorData}`);
Â  	    }
Â  	    Â 
Â  	    const resultText = await response.text();
Â  	    console.log("ë°ì´í„° ì „ì†¡ ì„±ê³µ:", resultText);

Â  	  } catch (error) {
Â  	    console.error("ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨:", error);
Â  	    alert('ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì½˜ì†” ë¡œê·¸ í™•ì¸ í•„ìš”)');Â 
Â  	  }
Â  	}

Â  	detailBtn.addEventListener('click', () => {
Â  	  const details = document.getElementById('details');
Â  	  if (details.classList.contains('hidden')) {
Â  	    details.classList.remove('hidden');
Â  	    details.classList.add('visible');
Â  	    detailBtn.innerText = 'ğŸ”½ ê³„ì‚° ê²°ê³¼ ìˆ¨ê¸°ê¸°';
Â  	  } else {
Â  	    details.classList.add('hidden');
Â  	    details.classList.remove('visible');
Â  	    detailBtn.innerText = 'ğŸ” ê³„ì‚° ê²°ê³¼ ìƒì„¸ë³´ê¸°';Â  Â  Â 
Â  	  }
Â  	});

Â  	diagnoseBtn.addEventListener('click', () => diagnose(false));Â 
Â  	simulateBtn.addEventListener('click', () => diagnose(true));

Â  	updateButtonState();
Â  </script>
</body>
</html>