<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전력 사용량 진단</title>
    <style>
        /* CSS 스타일링 */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { text-align: center; color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"], select, input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="checkbox"] { margin-right: 5px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        button:hover { background-color: #0056b3; }
        #result, #loading { margin-top: 20px; padding: 15px; border-radius: 4px; }
        #result { background-color: #e2f0d9; border: 1px solid #c6e0b4; display: none; }
        #loading { background-color: #ffeeba; border: 1px solid #ffdd57; text-align: center; display: none; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .field-group { margin-bottom: 15px; }
        .field-group label { display: block; margin-bottom: 5px; }
        .field-group input[type="radio"] { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>전력 사용량 진단</h1>
        <form id="powerDiagnoserForm">
            <div class="field-group">
                <label for="category">업종 분류:</label>
                <select id="category" required>
                    <option value="">선택하세요</option>
                    <option value="음식">음식점</option>
                    <option value="카페">카페</option>
                    <option value="사무실">사무실</option>
                    <option value="의류">의류 매장</option>
                    <option value="마트">마트/편의점</option>
                    <option value="병원">병원</option>
                    <option value="학원">학원</option>
                    <option value="미용">미용실</option>
                    <option value="기타">기타</option>
                </select>
            </div>

            <div class="field-group" id="subcategoryGroup" style="display: none;">
                <label for="subcategory">세부 업종 (직접 입력):</label>
                <input type="text" id="subcategory" placeholder="세부 업종을 입력하세요">
            </div>

            <div class="field-group">
                <label for="area">면적 (평):</label>
                <input type="number" id="area" min="1" required>
            </div>

            <div class="field-group">
                <label for="contract">현재 계약전력 (kW):</label>
                <input type="number" id="contract" min="1" required>
            </div>

            <div class="field-group">
                <label for="maxUsage">연중 최대 사용 월 전력량 (kWh):</label>
                <input type="number" id="maxUsage" min="1" required>
            </div>

            <div class="field-group">
                <label>24시간 운영 여부:</label><br>
                <input type="radio" id="is24h_yes" name="is24h" value="true" required>
                <label for="is24h_yes">예</label>
                <input type="radio" id="is24h_no" name="is24h" value="false" required>
                <label for="is24h_no">아니오</label>
            </div>

            <div class="field-group">
                <label>시뮬레이션 데이터 전송 여부:</label><br>
                <input type="radio" id="isSimulation_yes" name="isSimulation" value="true" required>
                <label for="isSimulation_yes">예</label>
                <input type="radio" id="isSimulation_no" name="isSimulation" value="false" required>
                <label for="isSimulation_no">아니오</label>
            </div>

            <div class="field-group">
                <label for="memo">기타 비고 (선택 사항):</label>
                <input type="text" id="memo" placeholder="추가 정보를 입력하세요">
            </div>

            <button type="submit">진단하기</button>
        </form>

        <div id="loading" style="display: none;">
            데이터 전송 중... 잠시만 기다려 주세요.
        </div>
        <div id="result" style="display: none;">
            <h2>진단 결과</h2>
            <p><strong>추천 계약전력:</strong> <span id="recommendedPowerDisplay"></span> kW</p>
            <p><strong>현재 계약전력과 추천전력의 차이:</strong> <span id="diffDisplay"></span> kW</p>
            <p><strong>계약전력 판단 결과:</strong> <span id="statusDisplay"></span></p>
            <p><strong>월 기본요금 차이:</strong> <span id="costDiffDisplay"></span> 원</p>
        </div>
        <div id="message" style="margin-top: 20px; text-align: center;"></div>
    </div>

    <script>
        // !!!!! 중요: 이 URL을 당신이 Cloudflare Worker를 배포했을 때 받은 URL로 변경하세요. !!!!!
        const googleScriptURL = "https://throbbing-block-3ed5.kknnd0728.workers.dev"; // <-- 여기에 YOUR_WORKER_URL_HERE 를 실제 워커 URL로 교체하세요!
        // 예를 들어: const googleScriptURL = "https://your-worker-name.your-username.workers.dev";
        // !!!!! !!!!! !!!!! !!!!! !!!!! !!!!! !!!!! !!!!! !!!!! !!!!! !!!!! !!!!! !!!!!

        let sessionId = localStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('sessionId', sessionId);
        }

        let inputStartTime;

        document.addEventListener('DOMContentLoaded', () => {
            inputStartTime = new Date().toISOString(); // 페이지 로드 시 입력 시작 시간 기록

            const categorySelect = document.getElementById('category');
            const subcategoryGroup = document.getElementById('subcategoryGroup');
            const subcategoryInput = document.getElementById('subcategory');

            categorySelect.addEventListener('change', () => {
                if (categorySelect.value === '기타') {
                    subcategoryGroup.style.display = 'block';
                    subcategoryInput.setAttribute('required', 'required');
                } else {
                    subcategoryGroup.style.display = 'none';
                    subcategoryInput.removeAttribute('required');
                    subcategoryInput.value = ''; // '기타'가 아닐 때 값 초기화
                }
            });

            document.getElementById('powerDiagnoserForm').addEventListener('submit', function(event) {
                event.preventDefault(); // 폼 기본 제출 방지

                const loadingDiv = document.getElementById('loading');
                const resultDiv = document.getElementById('result');
                const messageDiv = document.getElementById('message');

                loadingDiv.style.display = 'block';
                resultDiv.style.display = 'none';
                messageDiv.textContent = '';
                messageDiv.className = '';

                const diagnoseClickTime = new Date().toISOString(); // 진단 버튼 클릭 시간 기록

                // 입력 값 가져오기
                const categoryVal = document.getElementById('category').value;
                let subcategoryVal = '';
                if (categoryVal === '기타') {
                    subcategoryVal = document.getElementById('subcategory').value;
                    if (!subcategoryVal.trim()) {
                        messageDiv.textContent = "세부 업종을 입력해주세요.";
                        messageDiv.className = 'error';
                        loadingDiv.style.display = 'none';
                        return;
                    }
                } else {
                    subcategoryVal = categoryVal; // '기타'가 아니면 업종 분류를 세부 업종으로 사용
                }
                
                const area = document.getElementById('area').value;
                const contract = document.getElementById('contract').value;
                const maxUsage = document.getElementById('maxUsage').value;
                const is24h = document.querySelector('input[name="is24h"]:checked').value === 'true';
                const isSimulation = document.querySelector('input[name="isSimulation"]:checked').value === 'true';
                const memo = document.getElementById('memo').value;

                // 유효성 검사 (기본 HTML required 속성과 중복될 수 있으나, 한 번 더 확인)
                if (!categoryVal || !area || !contract || !maxUsage || !document.querySelector('input[name="is24h"]:checked') || !document.querySelector('input[name="isSimulation"]:checked')) {
                    messageDiv.textContent = "모든 필수 필드를 입력해주세요.";
                    messageDiv.className = 'error';
                    loadingDiv.style.display = 'none';
                    return;
                }
                if (parseInt(area) < 1 || parseInt(contract) < 1 || parseInt(maxUsage) < 1) {
                    messageDiv.textContent = "면적, 현재 계약전력, 최대 사용 전력량은 1 이상이어야 합니다.";
                    messageDiv.className = 'error';
                    loadingDiv.style.display = 'none';
                    return;
                }

                // 가상의 전력 계산 로직 (실제 서비스에서는 서버에서 수행)
                const areaFactor = parseFloat(area) * 0.1; // 예시
                const usageFactor = parseFloat(maxUsage) * 0.05; // 예시
                let recommendedPower = Math.ceil((areaFactor + usageFactor) / 10) * 10; // 10kW 단위로 반올림
                if (recommendedPower < 5) recommendedPower = 5; // 최소 5kW

                const diff = recommendedPower - parseInt(contract);
                let status = "적정";
                let costDiff = 0; // 월 기본요금 차이
                const unitCostPerKw = 7392; // 1kW당 월 기본요금 (대략적인 예시)

                if (diff > 0) {
                    status = "부족";
                    costDiff = diff * unitCostPerKw;
                } else if (diff < 0) {
                    status = "과다";
                    costDiff = Math.abs(diff) * unitCostPerKw;
                }

                const data = {
                    categoryVal: categoryVal,
                    subcategoryVal: subcategoryVal,
                    area: area,
                    contract: contract,
                    maxUsage: maxUsage,
                    is24h: is24h,
                    recommendedPower: recommendedPower,
                    diff: diff,
                    status: status,
                    costDiff: costDiff,
                    userAgent: navigator.userAgent, // 사용자 브라우저 정보
                    sessionId: sessionId, // 세션 ID
                    inputStartTime: inputStartTime, // 입력 시작 시간
                    diagnoseClickTime: diagnoseClickTime, // 진단 클릭 시간
                    isSimulation: isSimulation,
                    memo: memo
                };

                fetch(googleScriptURL, {
                    method: 'POST',
                    mode: 'cors', // CORS 모드로 설정
                    headers: {
                        'Content-Type': 'text/plain', // CORS 우회를 위한 Content-Type
                    },
                    body: JSON.stringify(data), // 데이터를 JSON 문자열로 변환하여 전송
                })
                .then(response => {
                    // 응답이 성공적이면 (2xx 상태 코드)
                    if (response.ok) {
                        return response.json(); // JSON 응답 파싱
                    } else {
                        // 응답이 실패 상태 코드일 경우
                        // 서버에서 보낸 에러 메시지를 확인하기 위해 텍스트로 파싱 시도
                        return response.text().then(text => {
                            throw new Error(`서버 응답 오류: ${response.status} ${response.statusText || ''} - ${text}`);
                        });
                    }
                })
                .then(result => {
                    // 성공적인 응답 처리
                    loadingDiv.style.display = 'none';
                    resultDiv.style.display = 'block';

                    document.getElementById('recommendedPowerDisplay').textContent = result.recommendedPower || recommendedPower;
                    document.getElementById('diffDisplay').textContent = result.diff || diff;
                    document.getElementById('statusDisplay').textContent = result.status || status;
                    document.getElementById('costDiffDisplay').textContent = result.costDiff || costDiff;
                    
                    messageDiv.textContent = "데이터 전송 성공 및 결과 표시!";
                    messageDiv.className = 'success'; // 성공 스타일 적용

                    // Apps Script로부터 실제 응답을 받으면 메시지 업데이트
                    if (result && result.message) {
                        messageDiv.textContent = "데이터 전송 성공: " + result.message;
                    }
                })
                .catch(error => {
                    // 네트워크 오류 또는 파싱 오류 등 예외 처리
                    loadingDiv.style.display = 'none';
                    resultDiv.style.display = 'none';
                    messageDiv.textContent = "데이터 전송 오류가 발생했습니다. 잠시 후 다시 시도해주세요. (" + error.message + ")";
                    messageDiv.className = 'error'; // 오류 스타일 적용
                    console.error("데이터 전송 실패:", error);
                });
            });
        });
    </script>
</body>
</html>